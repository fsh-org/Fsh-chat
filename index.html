<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Fsh Chat</title>
    <!-- Boiler plate------ -->
    <link rel="icon" href="https://fsh.plus/fsh.png" type="image/png">
    <meta name="description" content="Fsh chat app">
    <!-- ------- -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:image" content="https://fsh.plus/fsh.png"/>
    <meta name="theme-color" content="#a89c9b">
    <!-- ------------------ -->
    <link rel="stylesheet" href="/style.css">

		<!-- Test emoji picker i found -->
		<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

    <!-- twitter emojis -->
    <script src="https://unpkg.com/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script>
		
  </head>
  <body style="margin:0;padding:0;">
    <table>
      <tr>
        <td><img width="50" height="50" src="https://fsh.plus/fsh.png" alt="logo"></td>
        <td><h1 style="margin:0;">Fsh chat</h1></td>
      </tr>
    </table>
    <label for="name">Name:</label>
    <input id="name">
    <label id="Co"></label>
    <div class="list">
      <div id="msg" class="muu"></div>
			
      <div style="position:absolute;bottom:0;left:0;right:0;background-color:#111;">
        <textarea id="message" style="font-size:18px;margin-bottom:-6px;" rows="1" aria-label="Message"></textarea>
        <button onclick="send()" aria-label="send"><svg xmlns="http://www.w3.org/2000/svg" height="18" width="22" viewBox="0 0 512 512"><path fill="#fff" d="M307 34.8c-11.5 5.1-19 16.6-19 29.2v64H176C78.8 128 0 206.8 0 304C0 417.3 81.5 467.9 100.2 478.1c2.5 1.4 5.3 1.9 8.1 1.9c10.9 0 19.7-8.9 19.7-19.7c0-7.5-4.3-14.4-9.8-19.5C108.8 431.9 96 414.4 96 384c0-53 43-96 96-96h96v64c0 12.6 7.4 24.1 19 29.2s25 3 34.4-5.4l160-144c6.7-6.1 10.6-14.7 10.6-23.8s-3.8-17.7-10.6-23.8l-160-144c-9.4-8.5-22.9-10.6-34.4-5.4z"/></svg></button>
        <button onclick="document.getElementById('files').click()" aria-label="add file"><svg xmlns="http://www.w3.org/2000/svg" height="18" width="20" viewBox="0 0 576 512"><path fill="#fff" d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384v38.6C310.1 219.5 256 287.4 256 368c0 59.1 29.1 111.3 73.7 143.3c-3.2 .5-6.4 .7-9.7 .7H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 128zm48 96a144 144 0 1 1 0 288 144 144 0 1 1 0-288zm16 80c0-8.8-7.2-16-16-16s-16 7.2-16 16v48H368c-8.8 0-16 7.2-16 16s7.2 16 16 16h48v48c0 8.8 7.2 16 16 16s16-7.2 16-16V384h48c8.8 0 16-7.2 16-16s-7.2-16-16-16H448V304z"/></svg></button>
		
				<!-- Test emoji picker i found -->
        <!-- no, font awesome -->
				<!-- placeholder -->
        <!-- how toglee; hide/show?  ye the emoji picker-->
        <button onclick="pickmoji()" aria-label="emoji picker"><svg xmlns="http://www.w3.org/2000/svg" height="18" width="18" viewBox="0 0 512 512"><path fill="#fff" d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM164.1 325.5C182 346.2 212.6 368 256 368s74-21.8 91.9-42.5c5.8-6.7 15.9-7.4 22.6-1.6s7.4 15.9 1.6 22.6C349.8 372.1 311.1 400 256 400s-93.8-27.9-116.1-53.5c-5.8-6.7-5.1-16.8 1.6-22.6s16.8-5.1 22.6 1.6zM144.4 208a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm192-32a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></button>
				<emoji-picker class="dark" id="emojiPicker" style="--emoji-font-family:Twemoji Mozilla; position: absolute; bottom: 3px; right: 10px;display:none;"></emoji-picker>

				<script>
          let picker = document.getElementById('emojiPicker');
          let mess = document.getElementById('message'); // Such a big mess, yes
					let tempCursorPos = 0,
						emojiData;
					picker.style.display = "none";
					
					picker.customEmoji = [
							{
								name: 'Fsh',
								shortcodes: ['fsh'],
								url: './images/fsh.png',
								//category: 'fsh'
							},
              {
                name: 'Fsh Spin',
                shortcodes: ['fshspin', 'fsh spin'],
                url: './images/fsh.gif',
                //category: 'fsh'
              },
							{
								name: 'Trol',
								shortcodes: ['trol'],
								url: './images/troll.png',
								//category: 'fsh'
							},
							{
								name: 'Cat Nod',
								shortcodes: ['catnod', 'cat nod'],
								url: './images/catnod.gif',
								//category: 'fsh'
							},
							{
								name: 'Cat No',
								shortcodes: ['catno', 'cat no'],
								url: './images/catno.gif',
								//category: 'fsh'
							}
						];

					(async()=>{
						let res = await fetch("https://cdn.jsdelivr.net/npm/emoji-picker-element-data@%5E1/en/emojibase/data.json");
						emojiData = await res.json();
					})()
					
          function pickmoji() {
            if (picker.style.display == "") {
              picker.style.display = "none";
            } else {
							picker.style.display = "";
						}
          };
          // found function that does the adding itself
          function insertAtCursor(myField, myValue) {
            myField.value = myField.value.substring(0, tempCursorPos)
              + myValue
              + myField.value.substring(tempCursorPos, myField.value.length);
            tempCursorPos += myValue.length
            // works
          }

					//save pos
					/* On key */
          mess.addEventListener('keyup', e => {
						tempCursorPos = e.target.selectionStart
					});
					/* On click */
					mess.addEventListener('mouseup', e => {
						tempCursorPos = e.target.selectionStart
					})
					
          picker.addEventListener('emoji-click', event => {
						if('url' in event.detail.emoji){
							insertAtCursor(mess, `:${event.detail.emoji.name}:`)
						} else {
            	insertAtCursor(mess, event.detail.emoji.unicode)
						}
					});

          // now make emojis look good
					// dies
          // so about cistom emojis, yes? like maybe fsh one or somethin
				</script>
				
        <div class="lista" id="preview"></div>
      </div>
    </div>
    <input id="files" type="file" multiple style="display:none">
		<script src="/socket.io/socket.io.js"></script>
		<script>
      function tag(e) {
        return e.includes("image/") ? "img" :
          e.includes("video/") ? "video controls" :
          e.includes("audio/") ? "audio controls" :
          "img"
      }
      function tagend(e) {
        return e.includes("image/") ? "" :
          e.includes("video/") ? "</video>" :
          e.includes("audio/") ? "</audio>" :
          ""
      }
      function ico(e) {
        if (e.includes("image/")) {
          return '<svg xmlns="http://www.w3.org/2000/svg" height="16" width="12" viewBox="0 0 384 512"><path fill="#ffffff" d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM64 256a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm152 32c5.3 0 10.2 2.6 13.2 6.9l88 128c3.4 4.9 3.7 11.3 1 16.5s-8.2 8.6-14.2 8.6H216 176 128 80c-5.8 0-11.1-3.1-13.9-8.1s-2.8-11.2 .2-16.1l48-80c2.9-4.8 8.1-7.8 13.7-7.8s10.8 2.9 13.7 7.8l12.8 21.4 48.3-70.2c3-4.3 7.9-6.9 13.2-6.9z"/></svg>'
        } else if (e.includes("video/")) {
          return '<svg xmlns="http://www.w3.org/2000/svg" height="16" width="12" viewBox="0 0 384 512"><path fill="#ffffff" d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM64 288c0-17.7 14.3-32 32-32h96c17.7 0 32 14.3 32 32v96c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V288zM300.9 397.9L256 368V304l44.9-29.9c2-1.3 4.4-2.1 6.8-2.1c6.8 0 12.3 5.5 12.3 12.3V387.7c0 6.8-5.5 12.3-12.3 12.3c-2.4 0-4.8-.7-6.8-2.1z"/></svg>'
        } else if (e.includes("audio/")) {
          return '<svg xmlns="http://www.w3.org/2000/svg" height="16" width="12" viewBox="0 0 384 512"><path fill="#ffffff" d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zm2 226.3c37.1 22.4 62 63.1 62 109.7s-24.9 87.3-62 109.7c-7.6 4.6-17.4 2.1-22-5.4s-2.1-17.4 5.4-22C269.4 401.5 288 370.9 288 336s-18.6-65.5-46.5-82.3c-7.6-4.6-10-14.4-5.4-22s14.4-10 22-5.4zm-91.9 30.9c6 2.5 9.9 8.3 9.9 14.8V400c0 6.5-3.9 12.3-9.9 14.8s-12.9 1.1-17.4-3.5L113.4 376H80c-8.8 0-16-7.2-16-16V312c0-8.8 7.2-16 16-16h33.4l35.3-35.3c4.6-4.6 11.5-5.9 17.4-3.5zm51 34.9c6.6-5.9 16.7-5.3 22.6 1.3C249.8 304.6 256 319.6 256 336s-6.2 31.4-16.3 42.7c-5.9 6.6-16 7.1-22.6 1.3s-7.1-16-1.3-22.6c5.1-5.7 8.1-13.1 8.1-21.3s-3.1-15.7-8.1-21.3c-5.9-6.6-5.3-16.7 1.3-22.6z"/></svg>'
        } else {
          return '<svg xmlns="http://www.w3.org/2000/svg" height="16" width="18" viewBox="0 0 576 512"><path fill="#ffffff" d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384v38.6C310.1 219.5 256 287.4 256 368c0 59.1 29.1 111.3 73.7 143.3c-3.2 .5-6.4 .7-9.7 .7H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 128zm48 96a144 144 0 1 1 0 288 144 144 0 1 1 0-288zm59.3 107.3c6.2-6.2 6.2-16.4 0-22.6s-16.4-6.2-22.6 0L432 345.4l-36.7-36.7c-6.2-6.2-16.4-6.2-22.6 0s-6.2 16.4 0 22.6L409.4 368l-36.7 36.7c-6.2 6.2-6.2 16.4 0 22.6s16.4 6.2 22.6 0L432 390.6l36.7 36.7c6.2 6.2 16.4 6.2 22.6 0s6.2-16.4 0-22.6L454.6 368l36.7-36.7z"/></svg>'
        }
      }
      function resizeBase64Img(base64, newWidth, newHeight) {
    return new Promise((resolve, reject)=>{
        const canvas = document.createElement("canvas");
        canvas.width = newWidth;
        canvas.height = newHeight;
        let context = canvas.getContext("2d");
        let img = document.createElement("img");
        img.src = base64;
        img.onload = function () {
          context.scale(newWidth/img.width,  newHeight/img.height);
          context.drawImage(img, 0, 0); 
          resolve(canvas.toDataURL());               
        }
    });
      }
      function sizeBase64Img(base64) {
        return new Promise((resolve, reject)=>{
          let img = document.createElement("img");
          img.src = base64;
          img.onload = function () {
            resolve([img.width, img.height]);               
          }
        });
      }
function Markdown(txt) {
  return twemoji.parse(txt
    .replaceAll('\\n','<br>')
    .replaceAll(/(?<!\\)\*\*.+?(?<!\\)\*\*/g, function(match) {
      return "<b>"+match.replaceAll("**","")+"</b>"
    })
		// the one * thing works it makes italics
    .replaceAll(/(?<!\\)\*.+?(?<!\\)\*/g, function(match) {
      return "<i>"+match.replaceAll("*","")+"</i>"
    })
		// render custom emojis
		.replaceAll(/:(.*?):/g, function(match) {
			//console.log(picker.customEmoji)
			let thing = match.replace(/:/g,'').toLowerCase()
			let realEmoji, type;
			for(let emoj in picker.customEmoji){
				/*console.log(`-- Break --`)
				console.log(thing)
				console.log(picker.customEmoji)
				console.log(picker.customEmoji[emoj])
				console.log(picker.customEmoji[emoj].name)
				console.log(thing == picker.customEmoji[emoj].name)
        console.log("----------")*/
				//if(thing == picker.customEmoji[emoj]) {}
				for(let cusmoji in picker.customEmoji[emoj].shortcodes) {
					if(thing == picker.customEmoji[emoj].shortcodes[cusmoji]) {
          	type = "custom";
          	realEmoji = picker.customEmoji[emoj].url;
					};
				};
				for(let emoj in emojiData){
					for(let cusmoji in emojiData[emoj].shortcodes) {
						if(thing == emojiData[emoj].shortcodes[cusmoji]) {
							type = "real";
							realEmoji = emojiData[emoj].emoji;
						};
					};
				};
			};
			console.log(`REAL: ${realEmoji}`)
			if(!realEmoji) return match;
			// emoji class = resize
			if(type == "custom"){
      	return `<img class="emoji" src="${realEmoji}"/>`;
			} else {
				return realEmoji
			}
		  //return "<b>"+match.replaceAll("**","")+"</b>"
		}), {
      size: "svg",
      ext: ".svg"
    });
}

      let MF;
      
      var fel = document.getElementById('files')
      fel.onchange = function() {
        MF = [];
        Array.from(fel.files).forEach(e => {
          let dat = new FileReader();
          dat.readAsDataURL(e);
          dat.addEventListener("loadend", async() => {
            //console.log(dat.result)
            console.log(e.type)
            let final = dat.result;
            if (e.type.includes('image/')) {
              let size = await sizeBase64Img(dat.result)
              let compress = await resizeBase64Img(dat.result, size[0]/2, size[1]/2)
              final = compress
              if (dat.result.length < final.length) {
                final = dat.result
              }
              if (e.type.includes("gif")) {
                final = dat.result
              }
            } else if (e.type.includes("video/") || e.type.includes("audio/")) {
              final = dat.result
            } else {
              alert('Unsuported file type ' + e.type)
            }
            console.log(dat.result.length)
            console.log(final.length)
            MF.push(final);
            let fil = "";
            MF.forEach(e=>{
              fil += `<div style="max-width: 10vw;max-height: 10vh;position:relative;display:inline-block;">
<button style="position:absolute;top:2px;right:2px;z-index:10;background-color:#0008;" onclick="MF[MF.indexOf(this.parentElement.children[1].src)]='';this.parentElement.remove()"><svg xmlns="http://www.w3.org/2000/svg" height="16" width="14" viewBox="0 0 448 512"><path fill="#f00" d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg></button>
<div style="position:absolute;left:0;top:0;box-shadow: 0px 0px 10px 5px rgba(0,0,0,0.75);background-color:rgba(0,0,0,0.75);">${ico(e)}</div>
<${tag(e)} src="${e}" style="width: 100%">${tagend(e)}
</div>`
            })
            document.getElementById("preview").innerHTML = fil;
          })
        })
      }

			// name save
			document.getElementById("name").addEventListener("keyup", (event) => {
				localStorage.setItem("name", document.getElementById("name").value);
			});
			document.getElementById("name").value = localStorage.getItem("name");
			
      let la;
			
      let socket = io(window.location.origin, {
        path: "/socket.io",
				query:`username=${document.getElementById("name").value || ''}`
      });

      function send() {
        socket.emit('message', {
          username: document.getElementById('name').value,
          content: document.getElementById('message').value.replaceAll("\n","\\n"),
          files: (MF||[]).filter(e => {return e != ''})||[]
        });
        MF = [];
        fel.value = '';
        document.getElementById("preview").innerHTML = '';
        document.getElementById('message').value = '';
        document.getElementById("message").attributes.rows.value = 1;
      }
      
      var map = {};
      document.getElementById("message").onkeydown = document.getElementById("message").onkeyup = function(e){
          e = e || event; // to deal with IE
          map[e.keyCode] = e.type == 'keydown';
          //console.log(e.keyCode)
        if (map[13] && !map[16]) {
          send()
          e.preventDefault();
        }
        document.getElementById("message").attributes.rows.value = Math.min(Math.max(document.getElementById("message").value.split("\n").length, 1), 6);
      }
      
      socket.on("message", (data) => {
				console.log(data)
        document.getElementById("Co").innerHTML=`${data.userCount} <svg xmlns="http://www.w3.org/2000/svg" height="16" width="14" viewBox="0 0 448 512"><path fill="#ffffff" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/></svg>`
        
        let tim = new Date(data.time);
let fil ="";
        if (data.files.length || false) {
          if (data.content) {
            fil = '<br>'
          }
          data.files.forEach(e=>{
            fil += `<${tag(e)} src="${e}" onerror="this.remove()" style="max-width: 20vw;max-height: 20vh;">${tagend(e)}`
          })
        }
        let meg = `
${data.color == la||(!la) ? "":"<br>"}
  <span style="${data.color == la ? "display:none":""}">
  <b style="color:#${data.color}">${data.username || "No name"}</b>
  <time style="${data.time?"":"display:none;"}">
    ${tim.getHours()}:${String(tim.getMinutes()).padStart(2,"0")}
  </time>
  </span>
  <br>
  ${data.auth == "user" ? Markdown(data.content.replaceAll("<", "&lt;")) : data.content}
${fil}`;
        document.getElementById("msg").insertAdjacentHTML("beforeend", meg);

        la = data.color;
        document.getElementById("msg").scrollTop = document.getElementById("msg").scrollHeight;
      })

      socket.on("disconnect", (reason) => {
        tim = new Date();
        la = "Sys"
        document.getElementById("msg").innerHTML += `
<br>
<span>
  <b style="color:#888">Server</b>
  <time>${tim.getHours()}:${String(tim.getMinutes()).padStart(2,"0")}</time>
</span>
<br>
You have been disconnected (${reason})`
      })
  </script>
  </body>
</html>